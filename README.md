# Скрипт для постинга паков пикч с дёрпибуры на табуне

## Для чего нужен

Для автоматического составления таких паков, как пак [Дёрпи](https://tabun.everypony.ru/blog/I_love_Derpy/197952.html), [Селестии](https://tabun.everypony.ru/blog/Order_of_Celestia/197945.html), [Луны](https://tabun.everypony.ru/blog/Order_of_Luna/197980.html), [Найтмер Мун](https://tabun.everypony.ru/blog/vyxefcetrg787cowg/197829.html), [Твайки](https://tabun.everypony.ru/blog/Twilight/197978.html), [Старлайт](https://tabun.everypony.ru/blog/equalitychurch/197920.html) и подобных.

Пак составляется из лучших по рейтингу картинок с дёрпибуры за прошедшие несколько дней (по умолчанию неделя) и постится в черновики в указанный блог. После этого этот черновик нужно открыть, прочекать картинки (само собой, автоматически там может подсосоаться много трэша), выкинуть плохие и опубликовать.

## Как его использовать

1. Проверить, что на машине есть Python 3. Я проверял на 3.8, скорее всего заведётся на любом третьем и может даже на каком-нибудь из вторых, но я не проверял. Для линуксоидов это на 99% так и есть, виндузятникам придётся его [поставить самостоятельно](https://www.python.org/downloads/), если он не стоит. Стоит отметить, что последняя версия, которую можно поставить на семёрку — 3.8, 3.9 ставится только на 8.1 или десятку.

2. Поставить нужные модули, в особенности [tabun_api](https://andreymal.org/tabun/api_doc/main.html) от Андреймала (остальные, скорее всего, уже стоят):
```
pip3 install datetime json requests pathlib
pip3 install git+https://github.com/andreymal/tabun_api.git#egg=tabun_api[full]
```
Если `pip3` нет, то скорее всего, можно использовать команду `pip` вместо неё: такое бывает, если третий питон — единственный стоящий на машине.

3. Сконфигурировать скрипт (его конфигурация находится в его начале). Те параметры, которые нельзя оставить, как есть, и нужно поменять по сравнению с дефолтной конфигурацией, выделены галочками:

* [x] `username` — логин на табуне.
* [x] `password` — пароль от табуна.
* [ ] `proxy` — прокси, если нужен, иначе просто пустая строка.
* [ ] `mirror` — зеркало дёрпибуры (у меня работает то, которое там приведено, остальные без проксика недоступны).
* [x] `title` — название поста, в нём на место `___` (три подчёркивания) подставится номер пака (начинается с 1 и дальше увеличивается).
* [x] `tags` — теги, которые будут у поста.
* [ ] `blog_id` — численный идентификатор блога, куда постить или строка из URL ссылки на блог (например, ЯРОК — это `fanart`, ЗХ — `sketch_drawing`, БПНХ — `draw_help`, СБК — `rough_blog`, награнь — `borderline`). 0 — это персональный блог.
* [x] `pony` — дёрпибурной тег поньки, имени которой мы будем создавать пак.
* [ ] `also` — дополнительные теги.
* [ ] `tmpl_body` — шаблон поста. Здесь на место `__OP_PIC__` подставится ОП-пикча, на `__PIC_BLOCK__` — блок картинок в спойлерах.
* [ ] `tmpl_text_spoiler_header` — шаблон текстового заголовка спойлера. На место `___` подставится номер спойлера.
* [ ] `tmpl_pic_spoiler_header` — шаблон заголовка спойлера с картинкой. На место `___` подставится номер спойлера, на `__PIC__` — URL картинки из `spoilerpics`.
* [ ] `tmpl_op_pic` — шаблон ОП-пички. На место `__PIC__` подставится URL картинки-превью, на `__FULL__` — полная ссылка на хайрез картинки.
* [ ] `tmpl_spoiler_contents` — шаблон содержимого спойлера. На место `___` подставится номер спойлера, на `__PIC__` — URL картинки-превью, на `__FULL__` — полная ссылка на хайрез картинки.
* [ ] `spoilerpics` — здесь можно указать либо массив ссылок на пикчи, уже загруженные на табун, чтобы получить в заголовках спойлеров такую красоту, как в паках Селестии и Луны; либо просто оставить None или пустой массив, и тогда скрипт сгенерит текстовые заголовки спойлеров. Если `piclimit`, например, 15, но мы надеемся оставить только 10 пикч, то можно сделать массив только из 10 ссылок: если массив кончится раньше, чем надо, то оставшиеся спойлеры будут иметь текстовые заголовки.
* [ ] `timezone` — часовой пояс, для Москвы это `+03:00`.
* [ ] `config` — путь к файлу, где будет храниться номер последнего отправленного пака. Это нужно, чтобы автоматически его увеличивать в заголовке поста. Путь относителен от домашней директории пользователя (`~` в линуксе, и что-то типа `C:\Users\имя_пользователя` в винде). Файл можно редактировать, если нужно сбросить номер пака или, наоборот, переставить его на нужный. Если в файле, например, записана цифра 5, то скрипт отправит пак с номером 6 и изменит цифру в файле на 6. Если файл удалён или отсутствует, то он будет создан, а нумерация паков начнётся с 1.
* [ ] `period` — количество дней, за которые надо тянуть пикчи с дёрпибуры (например, 7 — это все пикчи за последнюю неделю).
* [ ] `piclimit` — количество пикч, которые надо тянуть с дёрпибуры (на 10-картинковый пак достаточно будет где-то 15 — всё равно часть из них отсеять придётся).

4. Запустить скрипт (а лучше — вообще добавить в `crontab` с интервалом в параметр `period`, линуксоиды это умеют).

Он сделает следующее:

* выкачает блок метаинформации о пикчах с дёрпибуры (сортировка по рейтингу (`score`), первые `piclimit + 1` пикч, максимум 50);
* загрузит для первой пикчи представления `medium` и `full`, а для всех остальных — `large` и `full` на табун;
* создаст пост, в котором первая пикча будет ОП-пикчей (КДПВ), а остальные будут запиханы под спойлеры, при этом по клику на каждую пикчу будет открываться её полный вариант в новой вкладке, а альттекстом будет служить её дескрипшен с дёрпибуры;
* запостит этот пост на табун в указанный блог в виде черновика.

После этого останется только залезть в свои черновики, убрать из пака неудачные картинки и опубликовать пост.

Если скрипт, допустим, запускается через `crontab` каждую неделю в условную, допустим, среду — единственное, что останется делать ручками, это заходить каждую среду на табун, чистить новопоявившийся черновик поста и публиковать его.

Коды возврата:
* 0 — всё отлично, можно лезть в черновики проверять появившийся пост;
* 1 — не получилось импортировать модуль `tabun_api`;
* 2 — не получилось достучаться до дёрпибуры;
* 3 — не получилось разобрать JSON, который вернула дёрпибура;
* 4 — не удалось залогиниться на табун;
* 5 — не удалось залить пикчи на табун;
* 9 — не удалось определить блог по его текстовому имени;
* 10 — не получилось запостить пост на табун.
